#include "sys.h"
#include "usart3.h"
#include "timer.h"


void USART3_SendData(u8 data)
{
	while((USART3->SR & 0X40) == 0);
	USART3->DR = data;
}

void USART3_SendString(u8 *DAT, u8 len)
{
	u8 i;
	for(i = 0; i < len; i++)
	{
		USART3_SendData(*DAT++);
	}
}

#if EN_USART3_RX   

u8 USART3_RX_BUF[USART3_REC_LEN]; 

u16 USART3_RX_STA = 0;

void USART3_Init(u32 bound)
{
	//GPIO?????¨¨??
	GPIO_InitTypeDef GPIO_InitStructure;
	USART_InitTypeDef USART_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);	//????USART3??GPIOC?¡À??
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART3, ENABLE);
	//USART3_TX   GPIOC.10
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	//???????¨¬????
	GPIO_Init(GPIOB, &GPIO_InitStructure);//??????GPIO

	//USART3_RX	  GPIOC.11??????
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//????????
	GPIO_Init(GPIOB, &GPIO_InitStructure);//??????GPIO

	//USART3 NVIC ????
	NVIC_InitStructure.NVIC_IRQChannel = USART3_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 3 ; //??????????3
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;		//¡Á???????3
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			//IRQ?¡§??????
	NVIC_Init(&NVIC_InitStructure);	//?¨´?????¡§????????????VIC?????¡Â

	//USART ???????¨¨??

	USART_InitStructure.USART_BaudRate = bound;//?????¡§????
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//¡Á??¡è??8??????????
	USART_InitStructure.USART_StopBits = USART_StopBits_1;//??????????
	USART_InitStructure.USART_Parity = USART_Parity_No;//?????????¨¦??
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//???????????¡Â????
	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//??¡¤?????

	USART_Init(USART3, &USART_InitStructure); //??????????1
	USART_ITConfig(USART3, USART_IT_RXNE, ENABLE);//????????????????
	USART_Cmd(USART3, ENABLE);                    //????????1

	TIM3_Int_Init(99, 7199);		//10ms????
	USART3_RX_STA = 0;		//????
	TIM_Cmd(TIM3, DISABLE);			//??¡À??¡§?¡À?¡Â7
}

void USART3_IRQHandler(void)                	//????1????¡¤??????¨°
{
	u8 Res;
	if(USART_GetITStatus(USART3, USART_IT_RXNE) != RESET)
	{
		Res = USART_ReceiveData(USART3);	//????????????????
		if((USART3_RX_STA & 0x8000) == 0) //???????¨º??
		{
			if(USART3_RX_STA < USART3_REC_LEN)	//??????????????
			{
				TIM_SetCounter(TIM3, 0); //?????¡Â????          				//?????¡Â????
				if(USART3_RX_STA == 0) 				//?????¡§?¡À?¡Â7??????
				{
					TIM_Cmd(TIM3, ENABLE); //?????¡§?¡À?¡Â7
				}
				USART3_RX_BUF[USART3_RX_STA++] = Res;	//??????????????
			}
			else
			{
				USART3_RX_STA |= 1 << 15;				//????¡À¨º???????¨º??
			}
		}
	}
}
#endif

